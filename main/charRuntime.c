
    #include "main.h"    
    #include "charRuntime.h"
    #include "attribute.h"
    

const unsigned char CHAR_DIRT[] = {

  0b1011,         //0b0
    0b0000,          //0b1
    0b0000,          //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111,         // 18
    0b0000,          // 19
    0b0000,          // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT1[] = {

  0b1011& ~1,     //0b0
    0b0000& ~1,     //0b1
    0b0000& ~1,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111,         // 18
    0b0000,          // 19
    0b0000,          // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT2[] = {

  0b1011,         //0b0
    0b0000,          //0b1
    0b0000,          //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101& ~1,          // 15
    0b0000& ~1,          // 16
    0b0000& ~1,          // 17
  0b0111& ~3,     // 18
    0b0000& ~3,     // 19
    0b0000& ~3,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};


const unsigned char DIRT3[] = {

  0b1011& ~1,     //0b0
    0b0000& ~1,     //0b1
    0b0000& ~1,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~1,     // 18
    0b0000& ~1,     // 19
    0b0000& ~1,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT4[] = {

  0b1011& ~0,     //0b0
    0b0000& ~0,     //0b1
    0b0000& ~0,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101& ~8,          // 15
    0b0000& ~8,          // 16
    0b0000& ~8,          // 17
  0b0111& ~8,     // 18
    0b0000& ~8,     // 19
    0b0000& ~8,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT5[] = {

  0b1011& ~1,     //0b0
    0b0000& ~1,     //0b1
    0b0000& ~1,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~8,     // 18
    0b0000& ~8,     // 19
    0b0000& ~8,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT6[] = {

  0b1011& ~0,     //0b0
    0b0000& ~0,     //0b1
    0b0000& ~0,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~9,     // 18
    0b0000& ~9,     // 19
    0b0000& ~9,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT7[] = {

  0b1011& ~1,     //0b0
    0b0000& ~1,     //0b1
    0b0000& ~1,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~9,     // 18
    0b0000& ~9,     // 19
    0b0000& ~9,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT8[] = {

  0b1011& ~8,     //0b0
    0b0000& ~8,     //0b1
    0b0000& ~8,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~0,     // 18
    0b0000& ~0,     // 19
    0b0000& ~0,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRT9[] = {

  0b1011& ~9,     //0b0
    0b0000& ~9,     //0b1
    0b0000& ~9,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~0,     // 18
    0b0000& ~0,     // 19
    0b0000& ~0,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTA[] = {

  0b1011& ~8,     //0b0
    0b0000& ~8,     //0b1
    0b0000& ~8,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~1,     // 18
    0b0000& ~1,     // 19
    0b0000& ~1,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTB[] = {

  0b1011& ~9,     //0b0
    0b0000& ~9,     //0b1
    0b0000& ~9,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~1,     // 18
    0b0000& ~1,     // 19
    0b0000& ~1,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTC[] = {

  0b1011& ~8,     //0b0
    0b0000& ~8,     //0b1
    0b0000& ~8,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~9,     // 18
    0b0000& ~9,     // 19
    0b0000& ~9,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTD[] = {

  0b1011& ~9,     //0b0
    0b0000& ~9,     //0b1
    0b0000& ~9,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~8,     // 18
    0b0000& ~8,     // 19
    0b0000& ~8,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTE[] = {

  0b1011& ~8,     //0b0
    0b0000& ~8,     //0b1
    0b0000& ~8,     //  2
  0b1110& ~8,          //  3
    0b0000& ~8,          //  4
    0b0000& ~8,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~9,     // 18
    0b0000& ~9,     // 19
    0b0000& ~9,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

const unsigned char DIRTF[] = {

  0b1011& ~9,     //0b0
    0b0000& ~9,     //0b1
    0b0000& ~9,     //  2
  0b1110,          //  3
    0b0000,          //  4
    0b0000,          //  5
  0b1011,         //  6
    0b0000,          //  7
    0b0000,          //  8
  0b1110,          //  9
    0b0000,          // 10
    0b0000,          // 11
  0b1111,         // 12
    0b0000,          // 13
    0b0000,          // 14
  0b1101,          // 15
    0b0000,          // 16
    0b0000,          // 17
  0b0111& ~9,     // 18
    0b0000& ~9,     // 19
    0b0000& ~9,     // 20

         // small
    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8

    0b0001,   //0b0
    0b0000,    //0b1
    0b0000,    //  2
    0b0001,   //  3
    0b0000,    //  4
    0b0000,    //  5
    0b0001,   //  6
    0b0000,    //  7
    0b0000,    //  8
};

// typedef struct {
//     unsigned char mask;
//     unsigned char offset;
// } MASK;


// const MASK dirtMask[] = {
//                                     //         where  blankers
//     {0b1110,0b0, },                 //0b0000,    TR      U+R 
//     {0b1110, PIECE_DEPTH - 3, },   //0b0001,    BR      D+R
//     {0b0111, PIECE_DEPTH - 3, },   //0b0010     BL      D+L
//     {0b0111,0b0, },                //0b0011,    TL      U+L
// };


void buildRuntimeDirt() {

    // Makes the rounded corner permutations of dirt character

    // for (unsigned char dirt =0b0; dirt < 16; dirt++) {

    //     for (int i =0b0; i < CHAR_ALLOC; i++)
    //         charRuntimeDirt[dirt][i] = DIRTY[i];

    //     for (int bit =0b0; bit < 4; bit++) {
    //         if (dirt& (1 << bit)) {
    //             unsigned char offset = dirtMask[bit].offset;
    //             unsigned char mask = dirtMask[bit].mask;
    //             for (int i =0b0; i < 3; i++)
    //                 charRuntimeDirt[dirt][offset + i]&= mask;
    //         }
    //     }

    // }

}

void roundDirtCorner(unsigned char *this) {

    // Round the corners of dirt chars where needed

    int U = Attribute[CharToType[*(this - 40)]]& ATT_ROUNDDIRT;
    int L = Attribute[CharToType[*(this - 1)]]& ATT_ROUNDDIRT;
    int R = Attribute[CharToType[*(this + 1)]]& ATT_ROUNDDIRT;
    int D = Attribute[CharToType[*(this + 40)]]& ATT_ROUNDDIRT;

    unsigned char roundedDirt = CH_DIRT;

    if (U&& R)
        roundedDirt += 1;

    if (R&& D)
        roundedDirt += 2;

    if (D&& L)
        roundedDirt += 4;

    if (L&& U)
        roundedDirt += 8;

    *this = roundedDirt;

}


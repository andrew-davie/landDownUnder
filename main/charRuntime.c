
    #include "main.h"    
    #include "charRuntime.h"
    #include "attribute.h"
    

const unsigned char DIRTY[] = {

     X_XX,          //  0
     ____,          //  1
     ____,          //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX,          // 18
     ____,          // 19
     ____,          // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT1[] = {

     X_XX & ~1,     //  0
     ____ & ~1,     //  1
     ____ & ~1,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX,          // 18
     ____,          // 19
     ____,          // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT2[] = {

     X_XX,          //  0
     ____,          //  1
     ____,          //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X & ~1,          // 15
     ____ & ~1,          // 16
     ____ & ~1,          // 17
     _XXX & ~3,     // 18
     ____ & ~3,     // 19
     ____ & ~3,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};


const unsigned char DIRT3[] = {

     X_XX & ~1,     //  0
     ____ & ~1,     //  1
     ____ & ~1,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~1,     // 18
     ____ & ~1,     // 19
     ____ & ~1,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT4[] = {

     X_XX & ~0,     //  0
     ____ & ~0,     //  1
     ____ & ~0,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X & ~8,          // 15
     ____ & ~8,          // 16
     ____ & ~8,          // 17
     _XXX & ~8,     // 18
     ____ & ~8,     // 19
     ____ & ~8,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT5[] = {

     X_XX & ~1,     //  0
     ____ & ~1,     //  1
     ____ & ~1,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~8,     // 18
     ____ & ~8,     // 19
     ____ & ~8,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT6[] = {

     X_XX & ~0,     //  0
     ____ & ~0,     //  1
     ____ & ~0,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~9,     // 18
     ____ & ~9,     // 19
     ____ & ~9,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT7[] = {

     X_XX & ~1,     //  0
     ____ & ~1,     //  1
     ____ & ~1,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~9,     // 18
     ____ & ~9,     // 19
     ____ & ~9,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT8[] = {

     X_XX & ~8,     //  0
     ____ & ~8,     //  1
     ____ & ~8,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~0,     // 18
     ____ & ~0,     // 19
     ____ & ~0,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRT9[] = {

     X_XX & ~9,     //  0
     ____ & ~9,     //  1
     ____ & ~9,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~0,     // 18
     ____ & ~0,     // 19
     ____ & ~0,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTA[] = {

     X_XX & ~8,     //  0
     ____ & ~8,     //  1
     ____ & ~8,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~1,     // 18
     ____ & ~1,     // 19
     ____ & ~1,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTB[] = {

     X_XX & ~9,     //  0
     ____ & ~9,     //  1
     ____ & ~9,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~1,     // 18
     ____ & ~1,     // 19
     ____ & ~1,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTC[] = {

     X_XX & ~8,     //  0
     ____ & ~8,     //  1
     ____ & ~8,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~9,     // 18
     ____ & ~9,     // 19
     ____ & ~9,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTD[] = {

     X_XX & ~9,     //  0
     ____ & ~9,     //  1
     ____ & ~9,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~8,     // 18
     ____ & ~8,     // 19
     ____ & ~8,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTE[] = {

     X_XX & ~8,     //  0
     ____ & ~8,     //  1
     ____ & ~8,     //  2
     XXX_ & ~8,          //  3
     ____ & ~8,          //  4
     ____ & ~8,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~9,     // 18
     ____ & ~9,     // 19
     ____ & ~9,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

const unsigned char DIRTF[] = {

     X_XX & ~9,     //  0
     ____ & ~9,     //  1
     ____ & ~9,     //  2
     XXX_,          //  3
     ____,          //  4
     ____,          //  5
     X_XX,          //  6
     ____,          //  7
     ____,          //  8
     XXX_,          //  9
     ____,          // 10
     ____,          // 11
     XXXX,          // 12
     ____,          // 13
     ____,          // 14
     XX_X,          // 15
     ____,          // 16
     ____,          // 17
     _XXX & ~9,     // 18
     ____ & ~9,     // 19
     ____ & ~9,     // 20

         // small
     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8

     ___X,    //  0
     ____,    //  1
     ____,    //  2
     ___X,    //  3
     ____,    //  4
     ____,    //  5
     ___X,    //  6
     ____,    //  7
     ____,    //  8
};

// typedef struct {
//     unsigned char mask;
//     unsigned char offset;
// } MASK;


// const MASK dirtMask[] = {
//                                     //         where  blankers
//     { 0b1110, 0, },                 // 0000     TR      U+R 
//     { 0b1110, PIECE_DEPTH - 3, },   // 0001     BR      D+R
//     { 0b0111, PIECE_DEPTH - 3, },   // 0010     BL      D+L
//     { 0b0111, 0, },                // 0011     TL      U+L
// };


void buildRuntimeDirt() {

    // Makes the rounded corner permutations of dirt character

    // for (unsigned char dirt = 0; dirt < 16; dirt++) {

    //     for (int i = 0; i < CHAR_ALLOC; i++)
    //         charRuntimeDirt[dirt][i] = DIRTY[i];

    //     for (int bit = 0; bit < 4; bit++) {
    //         if (dirt & (1 << bit)) {
    //             unsigned char offset = dirtMask[bit].offset;
    //             unsigned char mask = dirtMask[bit].mask;
    //             for (int i = 0; i < 3; i++)
    //                 charRuntimeDirt[dirt][offset + i] &= mask;
    //         }
    //     }

    // }

}

void roundDirtCorner(unsigned char *this) {

    if (CharToType[*this] == TYPE_DIRT) {

        // Round the corners of dirt chars where needed

        int U = Attribute[CharToType[*(this - 40)]] & ATT_ROUNDDIRT;
        int L = Attribute[CharToType[*(this - 1)]] & ATT_ROUNDDIRT;
        int R = Attribute[CharToType[*(this + 1)]] & ATT_ROUNDDIRT;
        int D = Attribute[CharToType[*(this + 40)]] & ATT_ROUNDDIRT;

        unsigned char roundedDirt = CH_DIRT;

        if (U && R)
            roundedDirt += 1;

        if (R && D)
            roundedDirt += 2;

        if (D && L)
            roundedDirt += 4;

        if (L && U)
            roundedDirt += 8;

        *this = roundedDirt;

    }


}


#include "main.h"
#include "drawplanet.h"
#include "defines_from_dasm_for_c.h"
#include "characterset.h"
#include "defines.h"

// duplicate from defines_cdfj.h
// Raw queue pointers
extern void* DDR;
#ifndef RAM
#define RAM ((unsigned char*)DDR)
#endif

//int planetX = 20 << 16;
//int planetY = (_ARENA_SCANLINES << 16) / 3 / 2;


// const int shadow[] = {
// 0b000000000000100100010000100000, // 3
// 0b000000000001001001001000100000, // 6
// 0b000000000001010100100100010000, // 9
// 0b000000000001010101010010010000, // 12
// 0b000000000001101010101010010000, // 15
// 0b000000000001101101101001001000, // 18
// 0b000000000001101101101001001000, // 21
// 0b000000000001110111010101001000, // 24
// 0b000000000001110111010101001000, // 27
// 0b000000000001111101101101001000, // 30
// 0b000000000001111101101101001000, // 33
// 0b000000000001111101101101001000, // 36
// 0b000000000001111111011010101000, // 39
// 0b000000000001111111011010101000, // 42
// 0b000000000001111111011010101000, // 45
// 0b000000000011110111111010101000, // 48
// 0b000000000011110111111010101000, // 51
// 0b000000000011110111111010101000, // 54
// 0b000000000011110111111010101000, // 57
// 0b000000000011110111111010101000, // 60
// 0b000000000011111111110110100100, // 63
// 0b000000000011111111110110100100, // 66
// 0b000000000011111111110110100100, // 69
// 0b000000000011111111110110100100, // 72
// 0b000000000011111111110110100100, // 75
// 0b000000000011111111110110100100, // 78
// 0b000000000011111111110110100100, // 81

// 0b000000000010101010100100100000, // 84
// 0b000000000001010101010010000100, // 87
// 0b000000000010101010100100100000, // 90
// 0b000000000001010101010010000100, // 93
// 0b000000000010101010100100100000, // 96
// 0b000000000011111111110110100100, // 99
// 0b000000000011111111110110100100, // 102
// 0b000000000011111111110110100100, // 105
// 0b000000000011110111111010101000, // 108
// 0b000000000011110111111010101000, // 111
// 0b000000000011110111111010101000, // 114
// 0b000000000011110111111010101000, // 117
// 0b000000000011110111111010101000, // 120
// 0b000000000001111111011010101000, // 123
// 0b000000000001111111011010101000, // 126
// 0b000000000001111111011010101000, // 129
// 0b000000000001111101101101001000, // 132
// 0b000000000001111101101101001000, // 135
// 0b000000000001111101101101001000, // 138
// 0b000000000001110111010101001000, // 141
// 0b000000000001110111010101001000, // 144
// 0b000000000001101101101001001000, // 147
// 0b000000000001101101101001001000, // 150
// 0b000000000001101010101010010000, // 153
// 0b000000000001010101010010010000, // 156
// 0b000000000001010100100100010000, // 159
// 0b000000000001001001001000100000, // 162
// 0b000000000000100100010000100000, // 165
// };

const int pix85[] = {
0b000000000000000000000000000000, // 0
0b000000000000100001000000010000, // 3
0b000000000001001001000100000100, // 6
0b000000000001010010010010000100, // 9
0b000000000001010010010010000100, // 12
0b000000000001010101001001000010, // 15
0b000000000010101010010100100010, // 18
0b000000000010101010010100100010, // 21
0b000000000010101011001010010010, // 24
0b000000000010101011001010010010, // 27
0b000000000010101011001010010010, // 30
0b000000000010110101101010010001, // 33
0b000000000010110101101010010001, // 36
0b000000000010110101101010010001, // 39
0b000000000010111011010101010001, // 42
0b000000000010111011010101010001, // 45
0b000000000010111011010101010001, // 48
0b000000000010111011010101010001, // 51
0b000000000010111011010101010001, // 54
0b000000000011011101101011001001, // 57
0b000000000011011101101011001001, // 60
0b000000000011011101101011001001, // 63
0b000000000011011101101011001001, // 66
0b000000000011011101101011001001, // 69
0b000000000011011101101011001001, // 72
0b000000000011011101101011001001, // 75
0b000000000011011101101011001001, // 78
0b000000000011011101101011001001, // 81
0b000000000011011101101011001001, // 84
0b000000000011011101101011001001, // 87
0b000000000011011101101011001001, // 90
0b000000000011011101101011001001, // 93
0b000000000011011101101011001001, // 96
0b000000000011011101101011001001, // 99
0b000000000011011101101011001001, // 102
0b000000000011011101101011001001, // 105
0b000000000011011101101011001001, // 108
0b000000000011011101101011001001, // 111
0b000000000011011101101011001001, // 114
0b000000000010111011010101010001, // 117
0b000000000010111011010101010001, // 120
0b000000000010111011010101010001, // 123
0b000000000010111011010101010001, // 126
0b000000000010111011010101010001, // 129
0b000000000010110101101010010001, // 132
0b000000000010110101101010010001, // 135
0b000000000010110101101010010001, // 138
0b000000000010101011001010010010, // 141
0b000000000010101011001010010010, // 144
0b000000000010101010010100100010, // 147
0b000000000010101010010100100010, // 150
0b000000000001010101001001000010, // 153
0b000000000001010101001001000010, // 156
0b000000000001010010010010000100, // 159
0b000000000001001001000100000100, // 162
0b000000000001000100001000001000, // 165
0b000000000000100001000000010000, // 168
};

const short int line85[] = {
0 , // 0
47 , // 3
73 , // 6
85 , // 9
105 , // 12
114 , // 15
131 , // 18
140 , // 21
149 , // 24
163 , // 27
172 , // 30
178 , // 33
192 , // 36
198 , // 39
204 , // 42
213 , // 45
227 , // 48
233 , // 51
236 , // 54
242 , // 57
256 , // 60
262 , // 63
268 , // 66
274 , // 69
288 , // 72
291 , // 75
297 , // 78
303 , // 81
309 , // 84
323 , // 87
326 , // 90
332 , // 93
338 , // 96
352 , // 99
358 , // 102
364 , // 105
367 , // 108
373 , // 111
387 , // 114
393 , // 117
399 , // 120
405 , // 123
419 , // 126
425 , // 129
431 , // 132
448 , // 135
454 , // 138
460 , // 141
469 , // 144
483 , // 147
492 , // 150
501 , // 153
518 , // 156
527 , // 159
547 , // 162
562 , // 165
588 , // 168
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
-1,
};


const unsigned int *precalcPix[] = {
//    pix10,
//    pix20,

    // pix25,
    // pix30,
    // pix35,
    // pix40,
    // pix45,
    // pix50,
    // pix55,
    // pix60,
    // pix65,
    // pix70,
    // pix74,
    // pix80,
    pix85,
};

const short int *precalcLine[] = {
    //line10, line20, 

    // line25,
    // line30, line35, line40, line45, line50, line55, line60,
    // line65, line70, line75, line80,
    //line74,
    line85,
};


int pscrollSpeed = 0x2800;
int sizer = 0;

unsigned int stepSize = 0x100;
unsigned int stepSize2 = 0x100;


unsigned int mult = (int) (1.25 * 0x100);
unsigned int div =  (int) (0x100 /1.25);
int equivalentLine = 0;
int absScanline = 0;

int scalex = 0xD0;

void drawPlanet() {

    scrollY = 0;



    // if (sizerDelay++ > 2) {
    //     sizer+= sizerDirection;
    //     if (sizer > 10 || sizer < 0) {
    //         sizer -= sizerDirection;
    //         sizerDirection = -sizerDirection;
    //     }
    //     sizerDelay = 0;
    // }


    int shift = 4- ((scrollX >> 14 ) & 3);
    int frac = scrollX >> 16;
    unsigned char *xchar;
    const unsigned char *image[6];


    int bufvid[2][2] = {
        { VIDBUF_PF0_LEFT, VIDBUF_PF0_RIGHT },
        { VIDBUF_PF0b_LEFT, VIDBUF_PF0b_RIGHT },
    };

    static int half = 0;

    

    //for (int half = 0; half < 2; half++) { 

        extern int toggle2;

        int buffer = (INPT4 & 0x80) ? toggle2 ^ 1 : toggle2;

        int base = bufvid[buffer][half];


//        int base = half ? VIDBUF_PF0_RIGHT : VIDBUF_PF0_LEFT;

        unsigned char *pf0 = RAM + buf[base] + absScanline;
        unsigned char *pf1 = RAM + buf[base + 1] + absScanline;
        unsigned char *pf2 = RAM + buf[base + 2] + absScanline;




        bool stopped = false;

        for (int line = 0; line < 50; line++) {

            if (absScanline >= SCANLINES || precalcLine[sizer][equivalentLine>>8] < 0) {
                stopped = true;
                break;
            }
                
            int equiv = equivalentLine >> 8;

            xchar = RAM + _BOARD + (half * 5 + frac) + boardWidth * (precalcLine[sizer][equiv] >> 5);
            int charow = precalcLine[sizer][equiv] & 31;

            for (int i = 0; i < 6; i++) {
                unsigned char piece = *xchar++;
                unsigned int type = CharToType[piece];
                if (Animate[type])
                    piece = (*Animate[type])[AnimIdx[type].index];
                image[i] = *charSet[piece] + charow;
            }


            int p2;

            int mask = precalcPix[sizer][equiv];
            // int shadowMask = shadow[scanline];

            for (int icc = 0; icc < 3; icc++) {

                absScanline++;

                int p = ((*image[0]++ & 0b1111) << 20
                      | (*image[1]++ & 0b1111) << 16
                      | (*image[2]++ & 0b1111) << 12
                      | (*image[3]++ & 0b1111) << 8
                      | (*image[4]++ & 0b1111) << 4
                      | (*image[5]++ & 0b1111)) >> shift;



                p2 = 0;

                if (!half) {

                    int bitOffset = 0;

                    for (int i = 0; i < 20; i++) {
                        if (mask & (1 << i))
                            p2 = (p2 << 1) | ((p >> (19-i)) & 1);
                    }

                    int p3 = 0;
                    for (int i = 0; i < 20; i++) {
                        int equivalentBit = bitOffset >> 8;
                        if (p2 & (1 << equivalentBit))
                            p3 |= 1 << i;
                        bitOffset += stepSize;
                    }
                    p2 = p3;

                }
                else {

                    // if (icc >0)
                        // p &= shadowMask;

                    int bitOffset = 0;
                    for (int i = 0; i < 20; i++) {
                        if (mask & (1 << i))
                            p2 = (p2 >> 1) | (((p >> i) & 1) << 19);
                    }

                    int p3 = 0;
                    for (int i = 19; i >= 0; i--) {
                        int equivalentBit = bitOffset >> 8;
                        if (p2 & (1 << (19-equivalentBit)))
                            p3 |= 1 << i;
                        bitOffset += stepSize;
                    }
                    p2 = p3;


                }

                *pf0++ = BitRev[p2 >> 16];
                *pf1++ = p2 >> 8;
                *pf2++ = BitRev[p2 & 0xFF];


            }
            equivalentLine += stepSize;

        }

        if (stopped) {

            while (absScanline++ < SCANLINES) {
                *pf0++ = 0;
                *pf1++ = 0;
                *pf2++ = 0;
            }


            drawSoftwareSprites();
    //    }

            absScanline = 0;
            equivalentLine = 0;

            half ^= 1;
            if (!half) {
                toggle2 ^= 1;
            }



            if (SWCHA & 0x40)
                pscrollSpeed += 100;
            if (SWCHA & 0x80)
                pscrollSpeed -= 100;

            if (!(SWCHA & 0x20)) {
                if (scalex < 0x200)
                    scalex+=5;
            }

            if (!(SWCHA & 0x10)) {
                if (scalex > 0x5)
                    scalex-=5;
            }

            stepSize = (0x100  * ((scalex * mult)>>8)) >> 8;
            stepSize2 = (0x100 * ((scalex * div)>>8)) >> 8;

            // if (sizerDelay > 1 && (SWCHA & 0x20)) {
            //     sizerDelay = 0;
            //     if (stepSize > 0x1000)
            //         stepSize -= 10;
            // }

            scrollX += pscrollSpeed;
            if (scrollX >= (30 << 16)) {
                scrollX -= (30 << 16);
            }
            if (scrollX < 0) {
                scrollX += 30 << 16; //+= (20 << 16);
            }


        }
}
